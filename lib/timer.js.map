{"version":3,"sources":["../src/timer.ts"],"names":["Timer","constructor","_pausing","_pause","_paused","_begin","getTime","next","f","p","Promise","r","call","nextRescissible","c","canceled","cancelError","undefined","cancel","resolve","reject","t","error","delayed","ms","setTimeout","clearTimeout","nextFrame","gl","requestAnimationFrame","bind","cancelAnimationFrame","performance","now","e","Date","run","pause","paused","time","get"],"mappings":"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","sourcesContent":["/** 计时器 */\r\nclass Timer {\r\n\t//暂停状态\r\n\t_pausing = false;\r\n\t//暂停开始时间\r\n\t_pause = 0;\r\n\t//已暂停时间\r\n\t_paused = 0;\r\n\t//初始化时间\r\n\t_begin = 0;\r\n\tconstructor() {\r\n\t\tthis._pausing = false;\r\n\t\tthis._pause = 0;\r\n\t\tthis._paused = 0;\r\n\t\tthis._begin = Timer.getTime();\r\n\t}\r\n\tstatic async next<T, P, R>(this: T, f: (this: T, r: (value?: R | PromiseLike<R>) => void, ...p: P[]) => any, ...p: P[]): Promise<R> {\r\n\t\treturn new Promise(r => f.call(this, r, ...p));\r\n\t}\r\n\tstatic nextRescissible<T, I, P, R>(this: T, f: (this: T, r: (value?: R | PromiseLike<R>) => I, ...p: P[]) => any, c: (t: I) => void, ...p: P[]): Promise<R> & { cancel(error?: any): void} {\r\n\t\tlet canceled = false;\r\n\t\tlet cancelError = undefined;\r\n\t\tlet cancel: undefined | ((error?: any) => void) = undefined;\r\n\t\tconst next = new Promise((resolve, reject) => {\r\n\t\t\tif (canceled) { return cancelError === undefined ? resolve() : reject(cancelError); }\r\n\t\t\tconst t = f.call(this, () => {\r\n\t\t\t\tcanceled = true;\r\n\t\t\t\tresolve();\r\n\t\t\t}, ...p);\r\n\t\t\tcancel = (error?: any) => {\r\n\t\t\t\tif (canceled) { return; }\r\n\t\t\t\tcanceled = true;\r\n\t\t\t\tc(t);\r\n\t\t\t\treturn error === undefined ? resolve() : reject(error);\r\n\t\t\t}\r\n\t\t}) as Promise<R> & { cancel(error?: any): void};\r\n\t\tnext.cancel = (error?: any) => {\r\n\t\t\tif (canceled) { return; }\r\n\t\t\tif (cancel) { cancel(error); }\r\n\t\t\tcancelError = error;\r\n\t\t\tcanceled = true;\r\n\t\t}\r\n\t\treturn next;\r\n\t}\r\n\t/** 延时 */\r\n\tstatic delayed(ms: number): Promise<void> & { cancel(error?: any): void} {\r\n\t\treturn Timer.nextRescissible(f => setTimeout(f, ms), clearTimeout);\r\n\t}\r\n\t/** 等待进入下一帧渲染 */\r\n\tstatic async nextFrame(gl: Window): Promise<void> {\r\n\t\treturn Timer.nextRescissible(gl.requestAnimationFrame.bind(gl), gl.cancelAnimationFrame.bind(gl));\r\n\t}\r\n\t/** 获取当前时间 */\r\n\tstatic getTime(): number {\r\n\t\ttry {\r\n\t\t\treturn performance.now();\r\n\t\t} catch (e) { }\r\n\t\treturn +new Date();\r\n\t}\r\n\t/** 继续计时 */\r\n\trun(): void {\r\n\t\tif (!this._pausing) {\r\n\t\t\treturn ;\r\n\t\t}\r\n\t\tthis._pausing = false;\r\n\t\tthis._paused += Timer.getTime() - this._pause;\r\n\t}\r\n\t/** 暂停计时 */\r\n\tpause(): void {\r\n\t\tif (this._pausing) {\r\n\t\t\treturn ;\r\n\t\t}\r\n\t\tthis._pausing = true;\r\n\t\tthis._pause = Timer.getTime();\r\n\t}\r\n\t/** 已暂停时间 */\r\n\tget paused(): number {\r\n\t\treturn this._paused + (this._pausing ? Timer.getTime() - this._pause : 0);\r\n\t}\r\n\t/** 已经执行时间 */\r\n\tget time(): number {\r\n\t\treturn (this._pausing ? this._pause : Timer.getTime()) - this._begin - this._paused;\r\n\t}\r\n\t/** 获取已经执行时间 */\r\n\tget() {\r\n\t\treturn this.time;\r\n\t}\r\n}\r\nexport default Timer;\r\n"],"file":"timer.js"}